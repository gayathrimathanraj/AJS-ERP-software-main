{% extends './base.html' %}
{% load static %}
{% block content %}

<div class="wrapper">
  {% include "./includes/sidebar.html" %}

  <div class="main-panel">
    <div class="main-header" style="background: content-box !important">
      <div class="main-header-logo">
        {% include "./includes/navbar.html" %}
      </div>

      <div class="container">
        <div class="page-inner ps-2 pe-2">

          <div class="page-header">
            <h3 class="fw-bold mb-3">Create Sales Invoice</h3>
            <ul class="breadcrumbs mb-3">
              <li class="nav-home">
                <a href="{% url 'ajserp:dashboard' %}">
                  <i class="icon-home"></i>
                </a>
              </li>
              <li class="separator"><i class="icon-arrow-right"></i></li>
              <li class="nav-item"><a href="#">Sales Invoice</a></li>
              <li class="separator"><i class="icon-arrow-right"></i></li>
              <li class="nav-item"><a href="#">Create Sales Invoice</a></li>
            </ul>
          </div>

          <div class="row">
            <div class="col-md-12 col-sm-12">
              <div class="card">
                <div class="card-header">
                  <div class="card-title">Sales Invoice</div>
                </div>

                <form method="POST" id="salesInvoiceForm" action="{% url 'ajserp:addsalesinvoice' %}">
                  {% csrf_token %}

                  <div class="card-body">
                    <div class="row">

                      <!-- SALES ORDER AUTOCOMPLETE -->
                      <div class="col-md-4">
                        <div class="form-group">
                          <label>Sales Order Number</label>
                          <input type="text" class="form-control" id="sales_order_search" placeholder="Search sales order...">
                          <input type="hidden" name="sales_order_id" id="sales_order_id">
                          <div id="sales_order_suggestions" class="suggestions-dropdown"></div>
                        </div>
                      </div>

                      <div class="col-md-4">
                        <label>Invoice Date</label>
                        <input type="date" name="date" class="form-control" id="id_date" required>
                      </div>

                      <div class="col-md-4">
                        <label>Warehouse Name</label>
                        <input type="text" class="form-control" id="warehouse_search" placeholder="Search warehouse..." required>
                        <input type="hidden" name="warehouse_code" id="warehouse_code">
                        <div id="warehouse_suggestions" class="suggestions-dropdown"></div>
                      </div>

                      <div class="col-md-4 mt-3">
                        <label>Created By</label>
                        <input type="text" class="form-control" value="{{ request.user.get_full_name }}" readonly>
                      </div>

                      <div class="col-md-4 mt-3">
                        <label>Ref Number</label>
                        <input type="text" class="form-control" name="ref_number" placeholder="Auto-generated">
                      </div>

                    </div>

                    <!-- CUSTOMER DETAILS -->
                    <div class="row mt-4">
                      <div class="col-md-6 p-4 bg-light rounded">
                        <h6><b>Bill To</b></h6>

                        <label class="mt-2">Customer Name</label>
                        <input type="text" class="form-control" id="customer_search" placeholder="Search customer..." required>
                        <input type="hidden" name="customer_code" id="customer_code">
                        <div id="customer_suggestions" class="suggestions-dropdown"></div>

                        <label class="mt-3">Address 1</label>
                        <input type="text" class="form-control" name="billing_address1" required>

                        <label class="mt-3">Address 2</label>
                        <input type="text" class="form-control" name="billing_address2">

                        <label class="mt-3">City</label>
                        <input type="text" class="form-control" name="billing_city" required>

                        <label class="mt-3">State</label>
                        <input type="text" class="form-control" name="billing_state" required>

                        <label class="mt-3">Postal Code</label>
                        <input type="text" class="form-control" name="billing_postal_code" required>
                      </div>
                    </div>

                    <!-- ITEMS TABLE -->
                    <div class="row mb-3 mt-4">
                      <div class="col-12">
                        <div class="table-responsive">
                          <table class="table table-bordered text-center">
                            <thead>
                              <tr>
                                <th>S.NO</th>
                                <th>Material Name</th>
                                <th>Quantity</th>
                                <th>MRP</th>
                                <th>Discount</th>
                                <th>Basic</th>
                                <th>Tax</th>
                                <th>Amount</th>
                              </tr>
                            </thead>

                            <tbody id="sales-invoice-items-body">
                              <!-- JS will replace rows when SO is selected -->
                              <tr class="line-item-row">
                                <td><span class="serial-number">1</span></td>

                                <!-- hidden material_id for backend/upcoming JS -->
                                <td>
                                  <input type="hidden" name="material_id[]" class="material-id" value="">
                                  <input type="text" class="form-control material-name" name="material_name[]">
                                </td>

                                <td><input class="form-control quantity" name="quantity[]" value="1" min="0" step="0.01"></td>
                                <td><input class="form-control mrp" name="mrp[]" readonly></td>
                                <td><input class="form-control discount" name="discount[]" value="0" min="0" step="0.01"></td>
                                <td><input class="form-control basic-amount" name="basic_amount[]" readonly></td>
                                <td><input class="form-control tax-amount" name="tax_amount[]" readonly></td>
                                <td class="d-flex align-items-center">
                                  <input class="form-control final-amount" name="final_amount[]" readonly>
                                  <button type="button" class="btn btn-sm btn-danger ms-2 delete-row" onclick="this.closest('tr').remove()">X</button>
                                </td>
                              </tr>
                            </tbody>
                          </table>
                        </div>

                        <button type="button" class="btn btn-link btn-sm" onclick="addEmptyRow()">+ Add Line</button>
                      </div>
                    </div>

                    <!-- DESCRIPTION + TOTALS PANEL -->
                    <div class="row mt-3">
                      <div class="col-md-6">
                        <label class="form-label pb-2">Description</label>
                        <textarea class="form-control" name="description" id="description" rows="4" placeholder="Enter description"></textarea>
                      </div>

                      <div class="col-md-6 d-flex justify-content-end">
    <div style="width: 300px;"> <!-- Fixed width box for neat alignment, same as salesorder -->
        
        <div class="d-flex align-items-center mb-2">
            <label class="me-2" style="width: 120px; text-align:right;">Taxable Amount</label>
            <div class="input-group" style="width: 50%;">
                <span class="input-group-text">₹</span>
                <input type="text" class="form-control" id="taxable-amount-display" value="0.00" readonly>
            </div>
        </div>

        <div class="d-flex align-items-center mb-2">
            <label class="me-2" style="width: 120px; text-align:right;">SGST</label>
            <div class="input-group" style="width: 50%;">
                <span class="input-group-text">₹</span>
                <input type="text" class="form-control" id="sgst-value-display" value="0.00" readonly>
            </div>
        </div>

        <div class="d-flex align-items-center mb-2">
            <label class="me-2" style="width: 120px; text-align:right;">CGST</label>
            <div class="input-group" style="width: 50%;">
                <span class="input-group-text">₹</span>
                <input type="text" class="form-control" id="cgst-value-display" value="0.00" readonly>
            </div>
        </div>

        <div class="d-flex align-items-center mb-2">
            <label class="me-2" style="width: 120px; text-align:right;">IGST</label>
            <div class="input-group" style="width: 50%;">
                <span class="input-group-text">₹</span>
                <input type="text" class="form-control" id="igst-value-display" value="0.00" readonly>
            </div>
        </div>

        <div class="d-flex align-items-center mb-2">
            <label class="me-2" style="width: 120px; text-align:right;">Cess</label>
            <div class="input-group" style="width: 50%;">
                <span class="input-group-text">₹</span>
                <input type="text" class="form-control" id="cess-value-display" value="0.00" readonly>
            </div>
        </div>

        <div class="d-flex align-items-center mb-2">
            <label class="me-2" style="width: 120px; text-align:right;">Round Off</label>
            <div class="input-group" style="width: 50%;">
                <span class="input-group-text">₹</span>
                <input type="number" class="form-control" name="round_off" id="round-off" value="0.00" step="0.01" onchange="updateFinalPanel()">
            </div>
        </div>

        <div class="d-flex align-items-center mb-2">
            <label class="me-2" style="width: 120px; text-align:right;"><b>Grand Total</b></label>
            <div class="input-group" style="width: 50%;">
                <span class="input-group-text">₹</span>
                <input type="text" class="form-control" id="grand-total-display" value="0.00" readonly>
            </div>
        </div>

    </div>
</div>

                    <!-- TERMS & CONDITIONS -->
                    <div class="col-12 mt-3">
                      <label class="form-label">Terms & Conditions</label>

                      <select id="invoice_terms_template_select" class="form-select form-select-sm" style="width:360px;">
                        <option value="">-- Select Template --</option>
                        {% for t in terms_list %}
                          <option value="{{ t.code }}" data-body="{{ t.description|escapejs }}">
                            {{ t.code }} - {{ t.title }}
                          </option>
                        {% endfor %}
                      </select>

                      <textarea class="form-control mt-2" name="terms_conditions" id="invoice_terms_textarea" rows="4"></textarea>
                    </div>

                    <!-- hidden fields container (JS will append extras here) -->
                    <div id="hidden-fields-container"></div>

                    <!-- BUTTONS -->
                    <div class="row">
                      <div class="col-12 text-end mt-4">
                        <button type="submit" class="btn btn-primary">Create</button>
                        <button type="button" onclick="history.back()" class="btn btn-danger">Cancel</button>
                      </div>
                    </div>

                  </div>
                </form>

              </div>
            </div>
          </div>

        </div>
      </div>

      {% include "./includes/footer.html" %}
    </div>

    {% include "./includes/template_setting.html" %}
  </div>
</div>

{% endblock %}
