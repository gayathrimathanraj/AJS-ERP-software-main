{% extends './base.html' %} 
{% load static %}
{% block content %}
<div class="wrapper">
<!-- Sidebar -->
{% include "./includes/sidebar.html" %}

<div class="main-panel">
<div class="main-header" style="background: content-box !important">
<div class="main-header-logo">
<!-- navbar -->
{% include "./includes/navbar.html" %}
</div>

<!--main content-->

<div class="container">
<div class="row">
<h3 class="fw-bold ms-3 ps-3 pt-3">Sales Order</h3>
<div class="page-header mt-1">
<div class="col-md-9">
<ul class="breadcrumbs mb-3">
<li class="nav-home">
<a href="{%url 'ajserp:dashboard'%}">
<i class="icon-home"></i>
</a>
</li>
<li class="separator">
<i class="icon-arrow-right"></i>
</li>
<li class="nav-item">
<a href="#">Sales</a>
</li>
<li class="separator">
<i class="icon-arrow-right"></i>
</li>
<li class="nav-item">
<a href="#">Sales Order</a>
</li>
</ul>
</div>
<div class="col-md-3 text-end">
<p class="demo">
<button
type="button"
data-bs-toggle="modal"
data-bs-target="#myModalimport"
title=""
class="btn btn-primary btn-round"
data-original-title=""
style="width: 91px; height: 36px"
>
Import
</button>
<a
href="{%url 'ajserp:addsalesorders'%}"
class="btn btn-primary btn-round"
style="width: 91px; height: 36px; padding-top: 6px"
>Add</a
>
</p>
<!-- ========import model================== -->
<div class="modal fade" id="myModalimport">
<div class="modal-dialog">
<div class="modal-content">
<!-- Modal Header -->
<div class="modal-header">
<h4 class="modal-title">Import Items</h4>
<button
type="button"
class="btn-close"
data-bs-dismiss="modal"
></button>
</div>

<!-- Modal body -->
<div class="modal-body">
<div class="container" style="text-align: center">
<h2></h2>
<br />
<div class="mb-3">
<input
class="form-control"
type="file"
id="formFile"
/>
</div>
<p>Required : Name, Unit and Sell Price</p>
</div>
</div>
<!-- Modal footer -->
<div class="modal-footer">
<button
type="button"
class="btn btn-success"
data-bs-dismiss="modal"
>
Submit
</button>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- ================================= table start======================== -->

<div class="container-fluid">
<div class="col-md-12">
<div class="card">
<div class="">
<div class="card-body" style="padding: 1.25rem">
<div class="container mt-3">
<div class="card p-4">
 <!-- ADD THIS FORM TAG -->
<form method="GET" id="filterForm">
<!-- First Row -->
<div class="row g-3 align-items-end mb-2">
<!-- Order Number -->
    <div class="col-12 col-md-2">
      <input type="text" 
             class="form-control" 
             name="order_number" 
             placeholder="Order Number..." 
             value="{{ request.GET.order_number }}"
             autocomplete="off"
             oninput="showOrderNumberSuggestions(this.value)"
             id="orderNumberInput"/>
      <div id="orderNumberSuggestions" class="dropdown-menu"></div>
    </div>

<!-- Customer Name -->
    <div class="col-12 col-md-4">
       <input type="text" 
             class="form-control" 
             name="customer_name" 
             placeholder="Customer Name..." 
             value="{{ request.GET.customer_name }}"
             autocomplete="off"
             oninput="showCustomerNameSuggestions(this.value)"
             id="customerNameInput"/>
      <div id="customerNameSuggestions" class="dropdown-menu"></div>
    </div>

<!-- Status -->
    <div class="col-12 col-md-3">
      <select class="form-select" name="status">
        <option value="">Select Status</option>
        <option value="Active" {% if request.GET.status == "Active" %}selected{% endif %}>Active</option>
        <option value="Inactive" {% if request.GET.status == "Inactive" %}selected{% endif %}>Inactive</option>
      </select>
    </div>
</div>



<!-- Second Row -->
<div class="row g-3 align-items-end">
<!-- From Date -->
<div class="col-12 col-md-3">
<label for="fromDate" class="form-label">From date</label>
<input type="date" name="from_date" id="fromDate" class="form-control" value="{{ request.GET.from_date }}">
</div>

<!-- To Date -->
<div class="col-12 col-md-3">
<label for="toDate" class="form-label">To date</label>
<input type="date" name="to_date" id="toDate" class="form-control" value="{{ request.GET.to_date }}">
</div>



<!-- Search Button -->
<div class="col-12 col-md-2">
<button type="submit" class="btn btn-primary w-50">
Search
</button>
</div>
</div>
</div>
</div>
{% comment %} ============================table
start============ {% endcomment %}
<div class="row">
<div class="col-md-12">
<div class="card">
<div class="">
<div class="">
<!-- bg-light = light gray background -->
<div class="card-body">
<div class="d-flex gap-2">
<div
class="d-flex justify-content-between"
style="width: 95%"
>

<!-- Global Search Box -->
<div class="input-group" style="width: 300px">
    <input type="text" 
           id="globalSearchInput" 
           name="q" 
           class="form-control" 
           placeholder="Search order number, customer name..." 
           value="{{ request.GET.q }}"
           autocomplete="off"
           oninput="showGlobalSuggestions(this.value)"/>
    <button class="btn btn-primary" type="button" onclick="performGlobalSearch()">
        Search
    </button>
    <div id="globalSuggestions" class="dropdown-menu"></div>
</div>  

    <!-- Clear Filters Button -->
    {% if request.GET %}
    <div class="input-group" style="width: 300px">
        <a href="{% url 'ajserp:salesorders' %}" class="btn btn-secondary w-50 mt-1">Clear All Filters</a>
    </div>
    {% endif %}
</div>
</div>
</div>

<!-- Search Results Info -->
<div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            {% if request.GET %}
                <p class="mb-0 text-muted">
                    Found <strong>{{ sales_orders.count }}</strong> sales order(s) matching your search
                    {% if request.GET.q %}for "{{ request.GET.q }}"{% endif %}
                    {% if request.GET.order_number %}for order "{{ request.GET.order_number }}"{% endif %}
                    {% if request.GET.customer_name %}for customer "{{ request.GET.customer_name }}"{% endif %}
                </p>
            {% else %}
                <p class="mb-0 text-muted">Total sales orders: <strong>{{ sales_orders.count }}</strong></p>
            {% endif %}
        </div>
    </div>
</div>
</div>
</div>
</div>
</div>



<div class="table-responsive">
<table
id="basic-datatables"
class="display table table-bordered table-sm table-striped align-middle table-hover text-center" style="border: 1px solid #d2caca;"
>
<thead style="padding: 13px 9px !important">
<tr class="align-middle text-center">
<th scope="col">
<input type="checkbox" id="selectAll">
</th>
<th style="padding: 10px 11px !important">
Sales&nbsp;Order&nbsp;No
</th>
<th style="padding: 10px 11px !important">
Date
</th>
<th style="padding: 10px 11px !important">
Customer&nbsp;Code
</th>
<th style="padding: 10px 11px !important">
Customer&nbsp;Name
</th>
<th>
Basic
</th>
<th>
Tax
</th>
<th>
Total
</th>
<th style="padding: 10px 11px !important">
City
</th>

<th style="padding: 10px 11px !important">
Action
</th>
</tr>
</thead>
<tbody>
  {% for sales_order in sales_orders %}
<tr class="align-middle text-center">
<td style="padding: 0px !important">
<input type="checkbox" class="rowCheckbox">
</td>
<td>
<a href="#" data-bs-toggle="modal" data-bs-target="#viewModal{{ sales_order.id }}">
                {{ sales_order.order_number }}</a>
</td>
<td style="padding: 0px 17px !important">
 {{ sales_order.date|date:"d/m/Y" }}
</td>
<td style="padding: 0px 17px !important">
  {{ sales_order.customer.customer_code }}
</td>
<td style="padding: 0px 17px !important">
  {{ sales_order.customer.customer_name }}
</td>
<td style="padding: 0px 17px !important">
  ₹{{ sales_order.taxable_amount|floatformat:2 }}
</td>
<td style="padding: 0px 17px !important">
  ₹{{ sales_order.total_tax|floatformat:2 }}
</td>
<td style="padding: 0px 17px !important">
  ₹{{ sales_order.grand_total|floatformat:2 }}
</td>
<td style="padding: 0px 17px !important">
   {{ sales_order.billing_city|default:"N/A" }}
</td>
<td>
  <div class="form-button-action">
    <!-- View Button -->
                <button type="button" 
                        data-bs-toggle="modal" 
                        data-bs-target="#viewModal{{ sales_order.id }}" 
                        class="btn btn-link btn-info btn-lg"
                        title="View Sales Order">
                    <i class="fa fa-eye"></i>
                </button>
     <!-- Edit Button -->
                <button type="button" 
                        data-bs-toggle="modal" 
                        data-bs-target="#editModal{{ sales_order.id }}" 
                        class="btn btn-link btn-primary btn-lg"
                        title="Edit Sales Order">
                    <i class="fa fa-edit"></i>
                </button>
                 <!-- Delete Button -->
                <button type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal{{ sales_order.id }}"
                        class="btn btn-link btn-danger"
                        title="Delete Sales Order">
                    <i class="fa fa-times"></i>
                </button>
  </div>
</td>
</tr>
 {% empty %}
<tr>
 <td colspan="10" class="text-center py-4">
            <div class="text-muted">
                <i class="fa fa-inbox fa-2x mb-2"></i><br>
                No sales orders found
            </div>
        </td>
    </tr>
    {% endfor %}
</tbody>
</table>
</div>

<!-- Pagination -->
<nav aria-label="Sales Order pagination">
    <ul class="pagination justify-content-end">
        <!-- Previous Page -->
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <a class="page-link">Previous</a>
            </li>
        {% endif %}

        <!-- Page Numbers -->
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active">
                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}

        <!-- Next Page -->
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <a class="page-link">Next</a>
            </li>
        {% endif %}
    </ul>
</nav>

<!-- Page Info -->
<div class="row mt-2">
    <div class="col-md-12">
        <p class="text-muted text-end">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} sales orders
        </p>
    </div>
</div>

<!-- ==================== VIEW SALES ORDER MODALS ==================== -->
{% for sales_order in page_obj %}
<!-- View Modal -->
<div class="modal fade" id="viewModal{{ sales_order.id }}">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Sales Order Details - {{ sales_order.order_number }}</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label><strong>Date</strong></label>
                            <p>{{ sales_order.date|date:"d/m/Y" }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label><strong>Delivery Date</strong></label>
                            <p>{{ sales_order.delivery_date|date:"d/m/Y" }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label><strong>Reference Number</strong></label>
                            <p>{{ sales_order.ref_number|default:"N/A" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Customer Details -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6><strong>Bill To</strong></h6>
                        <p><strong>{{ sales_order.customer.customer_name }}</strong><br>
                        {{ sales_order.billing_address1 }}<br>
                        {% if sales_order.billing_address2 %}{{ sales_order.billing_address2 }}<br>{% endif %}
                        {{ sales_order.billing_city }}, {{ sales_order.billing_state }}<br>
                        {{ sales_order.billing_postal_code }}<br>
                        Phone: {{ sales_order.customer.phone_number|default:"N/A" }}
                        </p>
                    </div>
                </div>

                <!-- Line Items -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>S.No</th>
                                        <th>Material Name</th>
                                        <th>Quantity</th>
                                        <th>MRP</th>
                                        <th>Discount</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in sales_order.sales_order_items.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ item.material_name }}</td>
                                        <td>{{ item.quantity }}</td>
                                        <td>₹{{ item.mrp|floatformat:2 }}</td>
                                        <td>₹{{ item.discount|floatformat:2 }}</td>
                                        <td>₹{{ item.amount|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center">No items found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
 <!-- ✅ TERMS & CONDITIONS (FIXED) -->
        <div class="row mt-4">
          <div class="col-12">
            <h6><strong>Terms & Conditions</strong></h6>
            <div class="border rounded p-3 bg-light" style="white-space: pre-line;">
              {{ sales_order.terms_conditions|default:"No terms available" }}
            </div>
          </div>
        </div>
                <!-- Totals -->
                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Taxable Amount:</strong>
                            <span>₹{{ sales_order.taxable_amount|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>CGST:</strong>
                            <span>₹{{ sales_order.cgst|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>SGST:</strong>
                            <span>₹{{ sales_order.sgst|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>IGST:</strong>
                            <span>₹{{ sales_order.igst|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Cess:</strong>
                            <span>₹{{ sales_order.cess|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Grand Total:</strong>
                            <span>₹{{ sales_order.grand_total|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                {% comment %} <button type="button" class="btn btn-primary">Print</button> {% endcomment %}
                <a href="{% url 'ajserp:salesorder_pdf' sales_order.id %}" 
   class="btn btn-primary" target="_blank">
    <i class="fa fa-print"></i> Print Sales Order
</a>
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Edit Sales Order Modals -->
{% for sales_order in page_obj %}
<div class="modal fade" id="editModal{{ sales_order.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Edit Sales Order - {{ sales_order.order_number }}</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- Modal Body -->
            <form method="post" action="{% url 'ajserp:edit_sales_order' sales_order.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="container">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Customer *</label>
                                <select name="customer" class="form-control" required>
                                    <option value="{{ sales_order.customer.id }}" selected>{{ sales_order.customer.customer_name }}</option>
                                    {% for customer in customers %}
                                    <option value="{{ customer.id }}">{{ customer.customer_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Sales Order Date *</label>
                                <input type="date" name="date" value="{{ sales_order.date|date:'Y-m-d' }}" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Delivery Date *</label>
                                <input type="date" name="delivery_date" value="{{ sales_order.delivery_date|date:'Y-m-d' }}" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Reference Number</label>
                                <input type="text" name="ref_number" value="{{ sales_order.ref_number|default:'' }}" class="form-control">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea name="description" class="form-control" rows="3">{{ sales_order.description|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Sales Order</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Delete Confirmation Modals -->
{% for sales_order in page_obj %}
<div class="modal fade" id="deleteModal{{ sales_order.id }}">
<div class="modal-dialog">
<div class="modal-content">
<!-- Modal Header -->
<div class="modal-header">
<h4 class="modal-title">Delete Confirmation</h4>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<!-- Modal Body -->
<div class="modal-body">
<div class="container" style="text-align: center;">
<h2>Delete Confirmation</h2><br>
<p>Are you sure you want to delete sales order {{ sales_order.order_number }}?</p>
</div>
</div>

<!-- Modal Footer -->
<div class="modal-footer" style="display:inline; text-align:center;">
<form method="post" action="{% url 'ajserp:delete_sales_order' sales_order.id %}">
{% csrf_token %}
<button type="button" class="btn btn-danger" data-bs-dismiss="modal">No</button>
<button type="submit" class="btn btn-success">Yes</button>
</form>
  </div>
</div>
</div>
</div>
</div>
{% endfor %}
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- ======================table end main content======================== -->

<!-- ====================footer start========================= -->

{% include "./includes/footer.html" %}
</div>
<!-- custom template setting -->
{% include "./includes/template_setting.html" %}
</div>
</div>

{% endblock %}