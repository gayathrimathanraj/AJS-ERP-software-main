{% extends './base.html' %} {% load static %} {% block content %}
<div class="wrapper">
<!-- Sidebar -->
{% include "./includes/sidebar.html" %}

<div class="main-panel">
<div class="main-header" style="background: content-box !important">
<div class="main-header-logo">
<!-- navbar -->
{% include "./includes/navbar.html" %}
</div>

<!--main content-->

<div class="container">
<div class="row">
<h3 class="fw-bold ms-3 ps-3 pt-3">Purchase Order</h3>
<div class="page-header mt-1">
<div class="col-md-9">
<ul class="breadcrumbs mb-3">
<li class="nav-home">
<a href="{%url 'ajserp:dashboard'%}">
<i class="icon-home"></i>
</a>
</li>
<li class="separator">
<i class="icon-arrow-right"></i>
</li>
<li class="nav-item">
<a href="#">Purchase</a>
</li>
<li class="separator">
<i class="icon-arrow-right"></i>
</li>
<li class="nav-item">
<a href="#">Purchase Order</a>
</li>
</ul>
</div>
<div class="col-md-3 text-end">
<p class="demo">
<button
type="button"
data-bs-toggle="modal"
data-bs-target="#myModalimport"
title=""
class="btn btn-primary btn-round"
data-original-title=""
style="width: 91px; height: 36px"
>
Import
</button>
<a
href="{%url 'ajserp:addpurchaseorder'%}"
class="btn btn-primary btn-round"
style="width: 91px; height: 36px; padding-top: 6px"
>Add</a
>
</p>
<!-- ========import model================== -->
<div class="modal fade" id="myModalimport">
<div class="modal-dialog">
<div class="modal-content">
<!-- Modal Header -->
<div class="modal-header">
<h4 class="modal-title">Import Items</h4>
<button
type="button"
class="btn-close"
data-bs-dismiss="modal"
></button>
</div>

<!-- Modal body -->
<div class="modal-body">
<div class="container" style="text-align: center">
<h2></h2>
<br />
<div class="mb-3">
<input
class="form-control"
type="file"
id="formFile"
/>
</div>
<p>Required : Name, Unit and Sell Price</p>
</div>
</div>
<!-- Modal footer -->
<div class="modal-footer">
<button
type="button"
class="btn btn-success"
data-bs-dismiss="modal"
>
Submit
</button>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- ================================= table start======================== -->

<div class="container-fluid">
<div class="col-md-12">
<div class="card">
<div class="">
<div class="card-body" style="padding: 1.25rem">
<div class="container mt-3">
<div class="card p-4">
<!-- ADD THIS FORM TAG -->
<form method="GET" id="filterForm">
<!-- First Row -->
<div class="row g-3 align-items-end mb-2">
<!-- Order Number -->
    <div class="col-12 col-md-2">
      <input type="text" 
             class="form-control" 
             name="order_number" 
             placeholder="PO Number..." 
             value="{{ request.GET.order_number }}"
             autocomplete="off"
             oninput="showOrderNumberSuggestions(this.value)"
             id="orderNumberInput"/>
      <div id="orderNumberSuggestions" class="dropdown-menu"></div>
    </div>
  

<!-- Vendor Name -->
    <div class="col-12 col-md-4">
       <input type="text" 
             class="form-control" 
             name="vendor_name" 
             placeholder="Vendor Name..." 
             value="{{ request.GET.vendor_name }}"
             autocomplete="off"
             oninput="showVendorNameSuggestions(this.value)"
             id="vendorNameInput"/>
      <div id="vendorNameSuggestions" class="dropdown-menu"></div>
    </div>

<!-- Status -->
    <div class="col-12 col-md-3">
      <select class="form-select" name="status">
        <option value="">Select Status</option>
        <option value="Active" {% if request.GET.status == "Active" %}selected{% endif %}>Active</option>
        <option value="Inactive" {% if request.GET.status == "Inactive" %}selected{% endif %}>Inactive</option>
      </select>
    </div>
</div>

<!-- Second Row -->
<div class="row g-3 align-items-end">
<!-- From Date -->
<div class="col-12 col-md-3">
<label for="fromDate" class="form-label">From date</label>
<input type="date" name="from_date" id="fromDate" class="form-control" value="{{ request.GET.from_date }}">
</div>

<!-- To Date -->
<div class="col-12 col-md-3">
<label for="toDate" class="form-label">To date</label>
<input type="date" name="to_date" id="toDate" class="form-control" value="{{ request.GET.to_date }}">
</div>
<!-- Status Checkboxes -->

<!-- Search Button -->
<div class="col-12 col-md-2">
<button type="submit" class="btn btn-primary w-50">
Search
</button>
</div>
</div>
</div>
</div>
{% comment %} ============================table
start============ {% endcomment %}
<div class="row">
<div class="col-md-12">
<div class="card">
<div class="">
<div class="">
<!-- bg-light = light gray background -->
<div class="card-body">
<div class="d-flex gap-2">
<div class="d-flex justify-content-between" style="width: 95%">
<!-- Global Search Box -->
<div class="input-group" style="width: 300px">
    <input type="text" 
           id="globalSearchInput" 
           name="q" 
           class="form-control" 
           placeholder="Search PO number, vendor name..." 
           value="{{ request.GET.q }}"
           autocomplete="off"
           oninput="showGlobalSuggestions(this.value)"/>
    <button class="btn btn-primary" type="button" onclick="performGlobalSearch()">
        Search
    </button>
    <div id="globalSuggestions" class="dropdown-menu"></div>
</div>  

    <!-- Clear Filters Button -->
    {% if request.GET %}
    <div class="input-group" style="width: 300px">
        <a href="{% url 'ajserp:purchaseorder' %}" class="btn btn-secondary w-50 mt-1">Clear All Filters</a>
    </div>
    {% endif %}
</div>
</div>
</div>

<!-- Search Results Info -->
<div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            {% if request.GET %}
                <p class="mb-0 text-muted">
                    Found <strong>{{ purchase_orders.count }}</strong> purchase order(s) matching your search
                    {% if request.GET.q %}for "{{ request.GET.q }}"{% endif %}
                    {% if request.GET.order_number %}for PO "{{ request.GET.order_number }}"{% endif %}
                    {% if request.GET.vendor_name %}for vendor "{{ request.GET.vendor_name }}"{% endif %}
                </p>
            {% else %}
                <p class="mb-0 text-muted">Total purchase orders: <strong>{{ purchase_orders.count }}</strong></p>
            {% endif %}
        </div>
    </div>
</div>
</div>
</div>
</div>
</div>

<div class="table-responsive">
<table
id="basic-datatables"
class="display table table-bordered table-sm table-striped align-middle table-hover text-center" style="border: 1px solid #d2caca;"
>
<thead style="padding: 13px 9px !important">
<tr>
<th>
<input type="checkbox" id="selectAll"/>
</th>
<th style="padding: 13px 9px !important">
PO Number
</th>
<th style="padding: 13px 9px !important">
Date
</th>
<th style="padding: 13px 9px !important">
Vendor Code
</th>
<th style="padding: 13px 9px !important">
Vendor Name
</th>
<th style="padding: 13px 9px !important">
Basic
</th>
<th>
Tax
</th>
<th style="padding: 13px 9px !important">
Total
</th>
<th style="padding: 13px 9px !important">
City
</th>

<th style="padding: 13px 9px !important">
Action
</th>
</tr>
</thead>
<tbody>
 {% for purchase_order in purchase_orders %}
<tr class="align-middle text-center">
<td style="padding: 0px !important">
<input type="checkbox" class="rowCheckbox">
</td>
<td>
<a href="#" data-bs-toggle="modal" data-bs-target="#viewModal{{ purchase_order.id }}">
                {{ purchase_order.order_number }}</a>
</td>
<td style="padding: 0px 17px !important">
 {{ purchase_order.date|date:"d/m/Y" }}
</td>
<td style="padding: 0px 17px !important">
  {{ purchase_order.vendor.vendor_code }}
</td>
<td style="padding: 0px 17px !important">
  {{ purchase_order.vendor.vendor_name }}
</td>
<td style="padding: 0px 17px !important">
  ₹{{ purchase_order.taxable_amount|floatformat:2 }}
</td>
<td style="padding: 0px 17px !important">
  ₹{{ purchase_order.total_tax|floatformat:2 }}
</td>
<td style="padding: 0px 17px !important">
  ₹{{ purchase_order.grand_total|floatformat:2 }}
</td>
<td style="padding: 0px 17px !important">
   {{ purchase_order.billing_city|default:"N/A" }}
</td>
<td>
  <div class="form-button-action">
    <!-- View Button -->
                <button type="button" 
                        data-bs-toggle="modal" 
                        data-bs-target="#viewModal{{ purchase_order.id }}" 
                        class="btn btn-link btn-info btn-lg"
                        title="View Purchase Order">
                    <i class="fa fa-eye"></i>
                </button>
     <!-- Edit Button -->
                <button type="button" 
                        data-bs-toggle="modal" 
                        data-bs-target="#editModal{{ purchase_order.id }}" 
                        class="btn btn-link btn-primary btn-lg"
                        title="Edit Purchase Order">
                    <i class="fa fa-edit"></i>
                </button>
                 <!-- Delete Button -->
                <button type="button"
                        data-bs-toggle="modal"
                        data-bs-target="#deleteModal{{ purchase_order.id }}"
                        class="btn btn-link btn-danger"
                        title="Delete Purchase Order">
                    <i class="fa fa-times"></i>
                </button>
  </div>
</td>
</tr>
 {% empty %}
<tr>
 <td colspan="10" class="text-center py-4">
            <div class="text-muted">
                <i class="fa fa-inbox fa-2x mb-2"></i><br>
                No purchase orders found
            </div>
        </td>
    </tr>
    {% endfor %}
</tbody>
</table>
</div>

<!-- Pagination -->
<nav aria-label="Purchase Order pagination">
    <ul class="pagination justify-content-end">
        <!-- Previous Page -->
        {% if page_obj.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Previous</a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <a class="page-link">Previous</a>
            </li>
        {% endif %}

        <!-- Page Numbers -->
        {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
                <li class="page-item active">
                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ num }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a>
                </li>
            {% endif %}
        {% endfor %}

        <!-- Next Page -->
        {% if page_obj.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Next</a>
            </li>
        {% else %}
            <li class="page-item disabled">
                <a class="page-link">Next</a>
            </li>
        {% endif %}
    </ul>
</nav>

<!-- Page Info -->
<div class="row mt-2">
    <div class="col-md-12">
        <p class="text-muted text-end">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} purchase orders
        </p>
    </div>
</div>

<!-- ==================== VIEW PURCHASE ORDER MODALS ==================== -->
{% for purchase_order in page_obj %}
<!-- View Modal -->
<div class="modal fade" id="viewModal{{ purchase_order.id }}">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Purchase Order Details - {{ purchase_order.order_number }}</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <div class="form-group">
                            <label><strong>Date</strong></label>
                            <p>{{ purchase_order.date|date:"d/m/Y" }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label><strong>Valid Till</strong></label>
                            <p>{{ purchase_order.valid_till|date:"d/m/Y" }}</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="form-group">
                            <label><strong>Reference Number</strong></label>
                            <p>{{ purchase_order.ref_number|default:"N/A" }}</p>
                        </div>
                    </div>
                </div>

                <!-- Vendor Details -->
                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6><strong>Bill To</strong></h6>
                        <p><strong>{{ purchase_order.vendor.vendor_name }}</strong><br>
                        {{ purchase_order.billing_address1 }}<br>
                        {% if purchase_order.billing_address2 %}{{ purchase_order.billing_address2 }}<br>{% endif %}
                        {{ purchase_order.billing_city }}, {{ purchase_order.billing_state }}<br>
                        {{ purchase_order.billing_postal_code }}<br>
                        Phone: {{ purchase_order.vendor.phone_number|default:"N/A" }}
                        </p>
                    </div>
                </div>

                <!-- Line Items -->
                <div class="row mb-3">
                    <div class="col-12">
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <thead>
                                    <tr>
                                        <th>S.No</th>
                                        <th>Material Name</th>
                                        <th>Quantity</th>
                                        <th>MRP</th>
                                        <th>Discount</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in purchase_order.purchase_order_items.all %}
                                    <tr>
                                        <td>{{ forloop.counter }}</td>
                                        <td>{{ item.material_name }}</td>
                                        <td>{{ item.quantity }}</td>
                                        <td>₹{{ item.mrp|floatformat:2 }}</td>
                                        <td>₹{{ item.discount|floatformat:2 }}</td>
                                        <td>₹{{ item.amount|floatformat:2 }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="6" class="text-center">No items found</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Totals -->
                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Taxable Amount:</strong>
                            <span>₹{{ purchase_order.taxable_amount|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>CGST:</strong>
                            <span>₹{{ purchase_order.cgst|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>SGST:</strong>
                            <span>₹{{ purchase_order.sgst|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>IGST:</strong>
                            <span>₹{{ purchase_order.igst|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Cess:</strong>
                            <span>₹{{ purchase_order.cess|floatformat:2 }}</span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <strong>Grand Total:</strong>
                            <span>₹{{ purchase_order.grand_total|floatformat:2 }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
             <a href="{% url 'ajserp:purchase_order_pdf' purchase_order.id %}" class="btn btn-primary" target="_blank">
    <i class="fa fa-print"></i> Print PDF
</a>
  
            </div>
        </div>
    </div>
</div>
{% endfor %}

<!-- Edit Purchase Order Modals -->
{% for purchase_order in page_obj %}
<div class="modal fade" id="editModal{{ purchase_order.id }}" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <!-- Modal Header -->
            <div class="modal-header">
                <h4 class="modal-title">Edit Purchase Order - {{ purchase_order.order_number }}</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <!-- Modal Body -->
            <form method="post" action="{% url 'ajserp:edit_purchase_order' purchase_order.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="container">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Vendor *</label>
                                <select name="vendor" class="form-control" required>
                                    <option value="{{ purchase_order.vendor.id }}" selected>{{ purchase_order.vendor.vendor_name }}</option>
                                    {% for vendor in vendors %}
                                    <option value="{{ vendor.id }}">{{ vendor.vendor_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Purchase Order Date *</label>
                                <input type="date" name="date" value="{{ purchase_order.date|date:'Y-m-d' }}" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Valid Till *</label>
                                <input type="date" name="valid_till" value="{{ purchase_order.valid_till|date:'Y-m-d' }}" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Reference Number</label>
                                <input type="text" name="ref_number" value="{{ purchase_order.ref_number|default:'' }}" class="form-control">
                            </div>
                            <div class="col-12">
                                <label class="form-label">Description</label>
                                <textarea name="description" class="form-control" rows="3">{{ purchase_order.description|default:'' }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Modal Footer -->
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Purchase Order</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

<!-- Delete Confirmation Modals -->
{% for purchase_order in page_obj %}
<div class="modal fade" id="deleteModal{{ purchase_order.id }}">
<div class="modal-dialog">
<div class="modal-content">
<!-- Modal Header -->
<div class="modal-header">
<h4 class="modal-title">Delete Confirmation</h4>
<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
</div>

<!-- Modal Body -->
<div class="modal-body">
<div class="container" style="text-align: center;">
<h2>Delete Confirmation</h2><br>
<p>Are you sure you want to delete purchase order {{ purchase_order.order_number }}?</p>
</div>
</div>

<!-- Modal Footer -->
<div class="modal-footer" style="display:inline; text-align:center;">
<form method="post" action="{% url 'ajserp:delete_purchase_order' purchase_order.id %}">
{% csrf_token %}
<button type="button" class="btn btn-danger" data-bs-dismiss="modal">No</button>
<button type="submit" class="btn btn-success">Yes</button>
</form>
  </div>
</div>
</div>
</div>
</div>
{% endfor %}
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>


<!-- ======================table end main content======================== -->

<!-- ====================footer start========================= -->

{% include "./includes/footer.html" %}
</div>
<!-- custom template setting -->
{% include "./includes/template_setting.html" %}
</div>
</div>

{% endblock %}