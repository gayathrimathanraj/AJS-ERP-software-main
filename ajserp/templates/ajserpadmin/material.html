{% extends './base.html' %} 
{% load static %} 
{% block content %}
<div class="wrapper">
<!-- Sidebar -->
{% include "./includes/sidebar.html" %}

<div class="main-panel">
<div class="main-header" style="background: content-box !important">
<div class="main-header-logo">
<!-- navbar -->
{% include "./includes/navbar.html" %}
</div>

<!--main content-->

<div class="container">
<div class="row">
<h3 class="fw-bold ms-3 ps-3 pt-3">Material</h3>
<div class="page-header mt-1">
<div class="col-md-9 col-sm-4">
<ul class="breadcrumbs mb-3">
<li class="nav-home">
<a href="{%url 'ajserp:dashboard'%}">
<i class="icon-home"></i>
</a>
</li>
<li class="separator">
<i class="icon-arrow-right"></i>
</li>
<li class="nav-item">
<a href="#">Inventory</a>
</li>
<li class="separator">
<i class="icon-arrow-right"></i>
</li>
<li class="nav-item">
<a href="#">Material</a>
</li>
</ul>
</div>

<div class="col-md-3 text-end">
<p class="demo">
<button
type="button"
data-bs-toggle="modal"
data-bs-target="#myModalimport"
title=" "
class="btn btn-primary btn-round"
data-original-title=""
style="width: 91px; height: 36px"
>
Import
</button>
<a
href="{%url 'ajserp:addmaterial'%}"
class="btn btn-primary btn-round"
style="width: 91px; height: 36px; padding-top: 6px"
>Add</a
>
</p>

<!-- ========import model================== -->
<div class="modal fade" id="myModalimport">
<div class="modal-dialog">
<div class="modal-content">
<!-- Modal Header -->
<div class="modal-header">
<h4 class="modal-title">Import Items</h4>
<button
type="button"
class="btn-close"
data-bs-dismiss="modal"
></button>
</div>

<!-- Modal body -->
<div class="modal-body">
<div class="container" style="text-align: center">
<h2></h2>
<br />
<div class="mb-3">
<input
class="form-control"
type="file"
id="formFile"
/>
</div>
<p>Required : Name, Unit and Sell Price</p>
</div>
</div>
<!-- Modal footer -->
<div class="modal-footer">
<button
type="button"
class="btn btn-success"
data-bs-dismiss="modal"
>
Submit
</button>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<div class="container-fluid">
<div class="col-md-12">
<div class="card">
<div class="">
<div class="card-body" style="padding: 1.25rem">
<div class="container mt-3">
<div class="card p-4">
<!-- ADD THIS FORM TAG -->
<form method="GET" id="filterForm">
<div class="row g-3 align-items-end mb-2">
<!-- Material name -->
<div class="col-md-4">
<input type="text" 
           id="materialNameInput" 
           name="material_name" 
           class="form-control" 
           placeholder="Start typing material name..." 
           value="{{ request.GET.material_name }}"
           autocomplete="off">
    <div id="materialNameSuggestions" class="autocomplete-suggestions"></div>
</div>
<!-- Category -->
<div class="col-md-2">
<select class="form-select" id="categorySelect" name="category">
<option selected value="">Select Category</option>
<option value="Service" {% if request.GET.category == "Service" %}selected{% endif %}>Service</option>
<option value="Material" {% if request.GET.category == "Material" %}selected{% endif %}>Material</option>
<option value="Spare" {% if request.GET.category == "Spare" %}selected{% endif %}>Spare</option>
</select>
</div>

<!-- Brand -->
<div class="col-md-2">
<select class="form-select" id="brandSelect" name="brand">
 <option value="">Select Brand</option>
            {% for brand in material_brands %}
            <option value="{{ brand.name }}" {% if request.GET.brand == brand.name %}selected{% endif %}>
                {{ brand.name }}
            </option>
            {% endfor %}
</select>
</div>

<!-- Status -->
<div class="col-md-2">
<select class="form-select" id="statusSelect" name="status">
<option selected value="">Select Status</option>
<option value="Active" {% if request.GET.status == "Active" %}selected{% endif %}>Active</option>
<option value="Inactive" {% if request.GET.status == "Inactive" %}selected{% endif %}>Inactive</option>
</select>
</div>

<!-- Search Button -->
<div class="col-12 col-md-2">
<button type="submit" class="btn btn-primary w-50">Search</button>

</div>
</div>
</div>
</form>  <!-- CLOSE FORM TAG -->
</div>
</div>

<!-- =================================items table start======================== -->

<div class="row">
<div class="col-md-12">
<div class="card">
<!-- bg-light = light gray background -->
<div class="card-body">
<div class="d-flex gap-2">
<div
class="d-flex justify-content-between"
style="width: 95%"
>
<!-- Left Search Box -->
<div class="input-group" style="width: 300px">
<input type="text" 
           id="globalSearchInput" 
           name="q" 
           class="form-control" 
           placeholder="Search material code, name, category..." 
           value="{{ request.GET.q }}"
           autocomplete="off"/>
    <button class="btn btn-primary" type="button" onclick="performGlobalSearch()">
        Search
    </button>
   
    <div id="globalSearchSuggestions" class="autocomplete-suggestions"></div>
     
</div>

<div class="input-group" style="width: 300px">
 {% if request.GET %}
<a href="{% url 'ajserp:material' %}" class="btn btn-secondary w-50 mt-1">Clear</a>
{% endif %}
</div>

<!-- Right Export Button -->
<div class="dropdown">
<button
class="btn btn-primary btn-round dropdown-toggle"
data-bs-toggle="dropdown"
style="
color: white;
width: 91px;
height: 36px;
"
>
Export
</button>
<ul class="dropdown-menu import_1">
<li>
<a class="dropdown-item" href="#">Excel</a>
</li>
<li>
<a class="dropdown-item" href="#">PDF</a>
</li>
</ul>
</div>
</div>
</div>
</div>

<!-- Search Results Info -->
<div class="card-body">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            {% if request.GET %}
                <p class="mb-0 text-muted">
                    Found <strong>{{ materials.count }}</strong> material(s) matching your search
                    {% if request.GET.q %}for "{{ request.GET.q }}"{% endif %}
                </p>
            {% else %}
                <p class="mb-0 text-muted">Total materials: <strong>{{ materials.count }}</strong></p>
            {% endif %}
        </div>
    </div>
</div>

<div class="table-responsive">
<table
id="basic-datatables"
class="display table table-bordered table-sm table-striped align-middle table-hover text-center" style="border: 1px solid #d2caca;"
>
<thead style="padding: 13px 9px !important">
<tr>
<th style="padding: 13px 9px !important">
<input type="checkbox" id="selectAll">
</th>
<th style="padding: 4px 0px !important">
Material Code
</th>
<th style="padding: 13px 9px !important">
Material Name
</th>
<th style="padding: 5px 0px !important">UOM</th>
<th>Category</th>
<th style="padding: 10px 9px !important">
Modal
</th>
<th style="padding: 13px 9px !important">
Brand
</th>
{% comment %} <th style="padding: 13px 9px !important">MRP</th>
<th style="padding: 13px 9px !important">Selling Price</th> {% endcomment %}

<th style="padding: 13px 9px !important">
HSN Code
</th>
<th style="padding: 13px 9px !important">
Action
</th>
</tr>
</thead>

{% comment %} <tbody>
<tr>
<td style="padding: 0px !important">
<input type="checkbox" class="rowCheckbox">
</td>
<td
data-bs-toggle="modal"
data-bs-target="#myModalitems"
style="padding: 4px 0px !important"
>
<a href="#"> FG0001</a>
</td>
<td style="padding: 4px 0px !important">
solar Power
</td>
<td style="padding: 4px 0px !important">
500 Kg
</td>
<td style="padding: 4px 0px !important">
Service
</td>
<td style="padding: 4px 0px !important">
M600
</td>
<td style="padding: 4px 0px !important">
Power Solar
</td>
<td style="padding: 4px 0px !important">
12445
</td>
<td>
<div class="form-button-action">
<button
type="button"
data-bs-toggle="tooltip"
title=""
class="btn btn-link btn-primary btn-lg"
data-original-title="Edit Task"
>
<i class="fa fa-edit"></i>
</button>

<button
type="button"
data-bs-toggle="modal"
data-bs-target="#myModaldelete"
title=""
class="btn btn-link btn-danger"
data-original-title="Remove"
>
<i class="fa fa-times"></i>
</button>
</div>
</td>
</tr>
<tr>
<td><input type="checkbox" class="rowCheckbox"></td>
<td
data-bs-toggle="modal"
data-bs-target="#myModalitems"
>
<a href="#">FG0004</a>
</td>
<td style="padding: 4px 0px !important">
solar Power
</td>
<td style="padding: 4px 0px !important">
500 Kg
</td>
<td style="padding: 4px 0px !important">
Service
</td>
<td style="padding: 4px 0px !important">
M600
</td>
<td style="padding: 4px 0px !important">
Power Solar
</td>
<td style="padding: 4px 0px !important">
12445
</td>
<td>
<div class="form-button-action">
<button
type="button"
data-bs-toggle="tooltip"
title=""
class="btn btn-link btn-primary btn-lg"
data-original-title="Edit Task"
>
<i class="fa fa-edit"></i>
</button>
<button
type="button"
data-bs-toggle="tooltip"
title=""
class="btn btn-link btn-danger"
data-original-title="Remove"
>
<i class="fa fa-times"></i>
</button>
</div>
</td>
</tr>
</tbody> {% endcomment %}

<tbody>
    {% for material in materials %}
    {% if material.category %}  <!-- ADDED SAFETY CHECK -->
    <tr>
        <td style="padding: 0px !important">
            <input type="checkbox" class="rowCheckbox">
        </td>
        <td data-bs-toggle="modal" data-bs-target="#myModalitems" style="padding: 4px 0px !important">
            <a href="#">{{ material.material_code }}</a>
        </td>
        <td style="padding: 4px 0px !important">{{ material.material_name }}</td>
        <td style="padding: 4px 0px !important">{{ material.uom }}</td>
        <td style="padding: 4px 0px !important">{{ material.category }}</td>
        <td style="padding: 4px 0px !important">{{ material.model }}</td>
        <td style="padding: 4px 0px !important">{{ material.brand }}</td>
        {% comment %} <td>₹{{ material.mrp|floatformat:2 }}</td>
        <td>₹{{ material.selling_price|floatformat:2 }}</td> {% endcomment %}
        <td style="padding: 4px 0px !important">{{ material.hsn_code }}</td>
        <td>
            <div class="form-button-action">
            
                {% comment %} <button type="button" class="btn btn-link btn-primary btn-lg">
                    <i class="fa fa-edit"></i>
                </button>
                <button type="button" class="btn btn-link btn-danger">
                    <i class="fa fa-times"></i>
                </button> {% endcomment %}
                 <!-- Edit Button -->
                 <!-- Edit Button -->
        <button type="button" 
                data-bs-toggle="modal" 
                data-bs-target="#editModal{{ material.category }}"
                class="btn btn-link btn-primary btn-lg"
                title="Edit Material">
            <i class="fa fa-edit"></i>
        </button>

        <!-- Delete Button -->
        <button type="button"
                data-bs-toggle="modal"
                data-bs-target="#deleteModal{{ material.category }}"
                class="btn btn-link btn-danger"
                title="Delete Material">
            <i class="fa fa-times"></i>
        </button>
            </div>
        </td>
    </tr>
     {% endif %}  <!-- END SAFETY CHECK -->
    {% endfor %}
</tbody>
</table>
</div>
<nav aria-label="Page navigation example">
<ul class="pagination justify-content-end">
<li class="page-item disabled">
<a class="page-link">Previous</a>
</li>
<li class="page-item">
<a class="page-link" href="#">1</a>
</li>
<li class="page-item active">
<a class="page-link" href="#">2</a>
</li>
<li class="page-item">
<a class="page-link" href="#">3</a>
</li>
<li class="page-item">
<a class="page-link" href="#">Next</a>
</li>
</ul>
</nav>

<!-- The Modal -->
<div class="modal fade" id="myModaldelete">
<div class="modal-dialog">
<div class="modal-content">
<!-- Modal Header -->
<div class="modal-header">
<h4 class="modal-title"></h4>
<button
type="button"
class="btn-close"
data-bs-dismiss="modal"
></button>
</div>

<!-- Modal body -->
<div class="modal-body">
<div
class="container"
style="text-align: center"
>
<h2>Delete Confirmation</h2>
<br />
<p>
Are you sure you want to delete this
Estimate account?
</p>
</div>
</div>

<!-- Modal footer -->
<div
class="modal-footer"
style="display: inline; text-align: center"
>
<button
type="button"
class="btn btn-success"
data-bs-dismiss="modal"
>
Yes
</button>
<button
type="button"
class="btn btn-danger"
data-bs-dismiss="modal"
>
No
</button>
</div>
</div>
</div>
</div>

<!-- The Modal -->
<div class="modal fade" id="myModalitems">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<!-- Modal Header -->
<div class="modal-header">
<h4 class="modal-title">Create Material</h4>
<button
type="button"
class="btn-close"
data-bs-dismiss="modal"
></button>
</div>
<div class="">
<!-- Card header with title and Active checklist -->
<div
class="card-header d-flex justify-content-between align-items-center"
>
<div class="card-title mb-0"></div>

<div class="d-flex align-items-center">
<label class="form-label me-3 mb-1"
>Active:</label
>
<div
class="form-check form-check-inline pb-2 ps-3"
>
<input
class="form-check-input"
type="checkbox"
id="activeYes"
value="Yes"
/>
<label
class="form-check-label"
for="activeYes"
>Yes</label
>
</div>
<div
class="form-check form-check-inline pb-2"
style="padding-left: 4px"
>
<input
class="form-check-input"
type="checkbox"
id="activeNo"
value="No"
/>
<label
class="form-check-label"
for="activeNo"
>No</label
>
</div>
</div>
</div>
<!--view content start-->
<!-- Card body (unchanged) -->
<div class="card-body">
<div class="row">
<!-- Column 1 -->
<div class="col-md-6 col-lg-4">
<div class="form-group">
<label for="text">Material code</label>
<input
type="text"
class="form-control"
id="text"
/>
</div>

<div class="form-group">
<label for="category">Category</label>
<input
type="text"
class="form-control"
id="text"
/>
</div>

<div class="form-group">
<label for="description"
>Item Description</label
>
<textarea
class="form-control"
id="description"
aria-label="With textarea"
></textarea>
</div>
</div>

<!-- Column 2 -->
<div class="col-md-6 col-lg-4">
<div class="form-group">
<label for="materialName"
>Material Name</label
>
<input
type="text"
class="form-control"
id="materialName"
/>
</div>

<div class="form-group">
<label for="model">Model</label>
<input
type="text"
class="form-control"
id="model"
/>
</div>

<div class="form-group">
<label for="hsnCode">HSN Code</label>
<input
type="text"
class="form-control"
id="hsnCode"
/>
</div>
</div>

<!-- Column 3 -->
<div class="col-md-6 col-lg-4">
<div class="form-group">
<label for="uom">UOM</label>
<input
type="text"
class="form-control"
id="text"
/>
</div>

<div class="form-group">
<label for="brand">Select Brand</label>
<input
type="text"
class="form-control"
id="text"
/>
</div>

<div class="form-group">
<label
for="uploadImages"
class="form-label mb-1"
>Upload Images</label
>
<input
type="file"
class="form-control"
id="uploadImages"
/>
</div>
</div>
</div>
</div>
<!-- Modal footer -->
<div class="modal-footer text-end">
<button
type="button"
class="btn btn-danger"
data-bs-dismiss="modal"
>
Close
</button>
</div>
</div>
</div>
</div>
</div>

<!-- ==================end model============== -->
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- ======================table end main content======================== -->

<!-- ====================footer start========================= -->

{% include "./includes/footer.html" %}
</div>
<!-- custom template setting -->
{% include "./includes/template_setting.html" %}
</div>
</div>

<!-- ==================== EDIT/DELETE MODALS ==================== -->
{% for material in materials %}
{% if material.category %}
<!-- Edit Modal for {{ material.material_code }} -->
<div class="modal fade" id="editModal{{ material.category }}">  <!-- FIXED: Use category -->
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Edit Material - {{ material.material_code }}</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'ajserp:edit_material' material.category %}" enctype="multipart/form-data">  <!-- FIXED: Use category -->
                {% csrf_token %}
                <div class="modal-body">
                    <!-- Card header with title and Active checklist -->
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <div class="card-title mb-0">Material Details</div>
                        <div class="d-flex align-items-center">
                            <label class="form-label me-3 mb-1">Active:</label>
                            <div class="form-check form-check-inline pb-2 ps-3">
                                <input class="form-check-input" type="checkbox" id="activeYes{{ material.category }}" name="active_status" {% if material.active_status %}checked{% endif %}>
                                <label class="form-check-label" for="activeYes{{ material.category }}">Yes</label>
                            </div>
                        </div>
                    </div>

                    <div class="row mt-3">
                        <!-- Column 1 -->
                        <div class="col-md-6 col-lg-4">
                            <div class="form-group">
                                <label>Material Code</label>
                                <input type="text" class="form-control" value="{{ material.material_code }}" readonly>
                            </div>

                            <div class="form-group">
                                <label for="category{{ material.category }}">Category *</label>
                                <input type="text" name="category" class="form-control" value="{{ material.category }}" required>
                            </div>

                            <div class="form-group">
                                <label for="description{{ material.category }}">Item Description</label>
                                <textarea name="description" class="form-control" aria-label="With textarea" rows="3">{{ material.description|default:"" }}</textarea>
                            </div>
                        </div>

                        <!-- Column 2 -->
                        <div class="col-md-6 col-lg-4">
                            <div class="form-group">
                                <label for="material_name{{ material.category }}">Material Name *</label>
                                <input type="text" name="material_name" class="form-control" value="{{ material.material_name }}" required>
                            </div>

                            <div class="form-group">
                                <label for="uom{{ material.category }}">UOM *</label>
                                <input type="text" name="uom" class="form-control" value="{{ material.uom }}" required>
                            </div>

                            <div class="form-group">
                                <label for="taxes{{ material.category }}">HSN Code</label>
                                <select name="taxes" class="form-control">
                                    <option value="">Select HSN Code</option>
                                    {% for tax in taxes %}
                                    <option value="{{ tax.hsn_code }}" {% if material.taxes.hsn_code == tax.hsn_code %}selected{% endif %}>
                                        {{ tax.hsn_code }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <!-- Column 3 -->
                        <div class="col-md-6 col-lg-4">
                            <div class="form-group">
                                <label for="model{{ material.category }}">Model</label>
                                <select name="model" class="form-control">
                                    <option value="">Select Model</option>
                                    {% for model in material_models %}
                                    <option value="{{ model.code }}" {% if material.model.code == model.code %}selected{% endif %}>
                                        {{ model.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="brand{{ material.category }}">Brand</label>
                                <select name="brand" class="form-control">
                                    <option value="">Select Brand</option>
                                    {% for brand in material_brands %}
                                    <option value="{{ brand.code }}" {% if material.brand.code == brand.code %}selected{% endif %}>
                                        {{ brand.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal for {{ material.material_code }} -->
<div class="modal fade" id="deleteModal{{ material.category }}">  <!-- FIXED: Use category -->
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Delete Confirmation</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{% url 'ajserp:delete_material' material.category %}">  <!-- FIXED: Use category -->
                {% csrf_token %}
                <div class="modal-body">
                    <div class="container" style="text-align: center">
                        <p>Are you sure you want to delete <strong>{{ material.material_name }}</strong>?</p>
                        <p class="text-danger"><small>This action cannot be undone.</small></p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger">Yes, Delete</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endif %}  <!-- END SAFETY CHECK -->
{% endfor %}

  {% endblock %}