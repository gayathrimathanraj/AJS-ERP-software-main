{% extends './base.html' %} 
{% load static %} 
{% block content %}

<div class="wrapper">
<!-- Sidebar -->
{% include "./includes/sidebar.html" %}

<div class="main-panel">
<div class="main-header" style="background: content-box !important">
<div class="main-header-logo">
<!-- navbar -->
{% include "./includes/navbar.html" %}
</div>

<!--main content-->
<div class="container">
<div class="page-inner ps-2 pe-2">
<div class="page-header">
<h3 class="fw-bold mb-3 ms-2">Update Price</h3>
<ul class="breadcrumbs mb-3">
<li class="nav-home">
<a href="{%url 'ajserp:dashboard'%}">
<i class="icon-home"></i
></a>
</li>
<li class="separator"><i class="icon-arrow-right"></i></li>
<li class="nav-item">Inventory</li>
<li class="separator"><i class="icon-arrow-right"></i></li>
<li class="nav-item"><a href="pricelists.html">Price</a></li>
<li class="separator"><i class="icon-arrow-right"></i></li>
<li class="nav-item"><a href="#">Update Price</a></li>
</ul>
</div>

<!-- Selection Filter Card -->
<div class="card mt-4">
<div class="card-header d-flex justify-content-between align-items-center">
<div class="card-title mb-0">Selection</div>
<div>
<button class="btn btn-success btn-sm me-2" style="width: 91px; height: 36px; padding-left: 6px">Save</button>
{% comment %} <button class="btn btn-danger btn-sm" style="width: 91px; height: 36px; padding-left: 6px">Cancel</button> {% endcomment %}
<button type="button" class="btn btn-danger" style="width: 91px; height: 36px; padding-left: 6px"  onclick="history.back()" >Cancel</button>
</div>
</div>

<div class="card-body">
<!-- Simple GET form -->
 <form method="GET" id="searchForm">
<!-- Action Buttons -->
<div class="card p-4">
<div class="row mb-2">
<div class="col-md-3">
<div class="form-group">
<label>Material code</label>
<input type="text" name="material_code" class="form-control" value="{{ search_params.material_code|default:'' }}" placeholder="Enter material code"/>
</div>
</div>
<div class="col-md-3">
<div class="form-group">
<label>Material Name</label>
<input type="text" name="material_name" class="form-control" value="{{ search_params.material_name|default:'' }}" placeholder="Enter material name"/>
</div>
</div>
<div class="col-md-3">
<div class="form-group">
<label>Category</label>
<select name="category" class="form-control">
    <option value="">All Categories</option>
    <option value="Service" {% if search_params.category == 'Service' %}selected{% endif %}>Service</option>
    <option value="Spare" {% if search_params.category == 'Spare' %}selected{% endif %}>Spare</option>
    <option value="Material" {% if search_params.category == 'Material' %}selected{% endif %}>Material</option>
</select>
</div>
</div>

<div class="col-md-3">
<label>Status</label><br />
<div class="form-check form-check-inline">
<input class="form-check-input" type="radio" name="status" value="Active" id="active" {% if search_params.status == 'Active' %}checked{% endif %}/>
<label class="form-check-label">Active</label>
</div>
<div class="form-check form-check-inline">
<input class="form-check-input" type="radio" name="status" value="Inactive" id="inactive" {% if search_params.status == 'Inactive' %}checked{% endif %}/>
<label class="form-check-label">Inactive</label>
</div>
</div>
<div class="col-md-3">
<div class="form-group">
<label>Model</label>
<input type="text" name="model" class="form-control" value="{{ search_params.model|default:'' }}" placeholder="Enter model"/>
</div>
</div>
<div class="col-md-3">
<div class="form-group">
<label>From date</label>
<input type="date" name="from_date" class="form-control" value="{{ search_params.from_date|default:'' }}"/>
</div>
</div>
<div class="col-md-3">
<div class="form-group">
<label>To date</label>
<input type="date" name="to_date" class="form-control" value="{{ search_params.to_date|default:'' }}"/>
</div>
</div>
<!-- Search Button -->
<div class="col-md-2">
<button
type="submit"
class="btn btn-primary w-50"
>
Search
</button>
</div>
</div>
</div>
</form>
</div>
<!-- Table Card -->
<div class="mt-7">
<div class="card-body">
<form method="POST" id="priceUpdateForm" action="{% url 'ajserp:addpricelists' %}">
{% csrf_token %}
<div class="card p-4">
<div class="table-responsive">
<table
class="table table-bordered table-sm text-center align-middle"
>
<div class="col-md-8 d-flex align-items-end mb-4">
{% comment %} <div class="input-group" style="width: 200px">
<input
type="text"
class="form-control"
placeholder="Search here..."
aria-label="Search"
/>
<button class="btn btn-primary" type="button">
Search
</button> {% endcomment %}
</div>
</div>
<thead class="table-light">
<tr>
<th>Material&nbsp;code</th>
<th style="padding: 7px 90px !important;">Material&nbsp;Name</th>
<th>UOM</th>
<th>Category</th>
<th>Model</th>
<th>Brand</th>

<th style="padding: 12px 44px !important;">MRP</th>
<th>Selling&nbsp;Price</th>
<th>From&nbsp;date</th>
<th>To&nbsp;date</th>
<th>Status</th>
<th>Action</th>
</tr>
</thead>
<tbody>
{% for material in materials %}
<tr>
<td>{{ material.material_code }}</td>
<td>{{ material.material_name }}</td>
<td>{{ material.uom }}</td>
<td>{{ material.category }}</td>
<td>{{ material.model.name|default:"-" }}</td>
<td>{{ material.brand.name|default:"-" }}</td>
<!-- INPUT FIELDS SECTION -->
<td style="padding: 6px 8px !important;">
    <input type="hidden" name="material_code" value="{{ material.material_code }}">
    <input type="number" name="mrp_price" class="form-control" placeholder="MRP" step="0.01" min="0"
           value="{{ material.mrp|default:'0' }}">
</td>
<td>
    <input type="number" name="selling_price" class="form-control" placeholder="Selling Price" step="0.01" min="0"
           value="{{ material.selling_price|default:'0' }}">
</td>
<td style="padding: 4px 19px !important;">
    <input type="date" name="from_date" class="form-control" 
           value="{{ material.price_from_date|date:'Y-m-d'|default:'' }}">
</td>
<td style="padding: 6px 7px !important;">
    <input type="date" name="to_date" class="form-control"
           value="{{ material.price_to_date|date:'Y-m-d'|default:'' }}">
</td>
<td style="padding: 9px 0px !important">
    <select class="form-select" name="status" style="background-color: {% if material.pricing_status == 'Active' %}#d4edda{% else %}#f8d7da{% endif %}">
        <option value="Active" {% if material.pricing_status == 'Active' %}selected{% endif %}>Active</option>
        <option value="Inactive" {% if material.pricing_status != 'Active' %}selected{% endif %}>Inactive</option>
    </select>
</td>
<td>
        <div class="form-button-action">
             <!-- Edit Button -->
        <button type="button" 
                data-bs-toggle="modal" 
                data-bs-target="#editModal{{ material.material_code }}"
                class="btn btn-link btn-primary btn-lg"
                title="Edit Price">
            <i class="fa fa-edit"></i>
        </button>

        <!-- Delete Button -->
        <button type="button"
                data-bs-toggle="modal"
                data-bs-target="#deleteModal{{ material.material_code }}"
                class="btn btn-link btn-danger"
                title="Reset Price">
            <i class="fa fa-times"></i>
        </button>
            
        </div>
    </td>
</tr>
{% empty %}
<tr>
    <td colspan="11" class="text-center">No materials found in the database.</td>
</tr>
{% endfor %}
<!-- Add more rows as needed -->
</tbody>
</table>
</div>
</form>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Footer -->
{% include "./includes/footer.html" %}
</div>
<!-- custom template setting -->
{% include "./includes/template_setting.html" %}
</div>
</div>

<!-- ==================== EDIT/DELETE MODALS ==================== -->
{% for material in materials %}
    <!-- Edit Modal for {{ material.material_code }} -->
    <div class="modal fade" id="editModal{{ material.material_code }}">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Edit Price - {{ material.material_name }}</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'ajserp:edit_price' material_code=material.material_code %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="row">
                            {% comment %} <div class="col-md-6">
                                <div class="form-group">
                                    <label>Material Code</label>
                                    <input type="text" class="form-control" value="{{ material.material_code }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Material Name</label>
                                    <input type="text" class="form-control" value="{{ material.material_name }}" readonly>
                                </div>
                            </div> {% endcomment %}
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>MRP *</label>
                                    <input type="number" name="mrp_price" class="form-control" step="0.01" min="0" 
                                           value="{{ material.mrp|default:'0' }}" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label>Selling Price *</label>
                                    <input type="number" name="selling_price" class="form-control" step="0.01" min="0" 
                                           value="{{ material.selling_price|default:'0' }}" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Update Price</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Modal for {{ material.material_code }} -->
    <div class="modal fade" id="deleteModal{{ material.material_code }}">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h4 class="modal-title">Reset Price Confirmation</h4>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form method="POST" action="{% url 'ajserp:delete_price' material_code=material.material_code %}">
                    {% csrf_token %}
                    <div class="modal-body">
                        <div class="container" style="text-align: center">
                            <p>Are you sure you want to reset prices for <strong>{{ material.material_name }}</strong>?</p>
                            <p class="text-danger"><small>This will set MRP and Selling Price to 0.</small></p>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-danger">Yes, Reset</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endfor %}

  {% endblock %}