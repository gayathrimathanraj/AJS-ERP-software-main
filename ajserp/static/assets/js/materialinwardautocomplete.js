// static/assets/js/material-inward-autocomplete.js
$(document).ready(function(){
    let typingTimer;
    const doneTypingInterval = 300;

    // Initialize auto-generated fields
    initializeAutoGeneratedFields();

    // Material Search Autocomplete
    $("#material_search").on("input", function(){
        clearTimeout(typingTimer);
        let query = $(this).val();

        if (query.length === 0) {
            $("#material_suggestions").empty();
            clearMaterialFields();
            return;
        }

        typingTimer = setTimeout(function(){
            $.ajax({
                url: "/ajserp/api/material-autocomplete/",
                data: {q: query},
                dataType: "json",
                success: function(data){
                    let items = "";
                    
                    data.forEach(function(material){
                        items += `
                            <div class="suggestion-item" 
                                 data-material='${JSON.stringify(material)}'>
                                <strong>${material.material_name}</strong>
                                <small>${material.material_code}</small>
                            </div>`;
                    });
                    $("#material_suggestions").html(items);
                },
                error: function(err) {
                    console.error("Material API Error:", err);
                    $("#material_suggestions").html("<div class='suggestion-item text-danger'>Error loading materials</div>");
                }
            });
        }, doneTypingInterval);
    });

    // Vendor Search Autocomplete  
    $("#vendor_search").on("input", function(){
        clearTimeout(typingTimer);
        let query = $(this).val();

        if (query.length === 0) {
            $("#vendor_suggestions").empty();
            clearVendorFields();
            return;
        }

        typingTimer = setTimeout(function(){
            $.ajax({
                url: "/ajserp/api/vendor-autocomplete/",
                data: {q: query},
                dataType: "json",
                success: function(data){
                    let items = "";
                    
                    data.forEach(function(vendor){
                        items += `
                            <div class="suggestion-item" 
                                 data-vendor='${JSON.stringify(vendor)}'>
                                <strong>${vendor.vendor_name}</strong>
                                <small>${vendor.vendor_code}</small>
                            </div>`;
                    });
                    $("#vendor_suggestions").html(items);
                },
                error: function(err) {
                    console.error("Vendor API Error:", err);
                    $("#vendor_suggestions").html("<div class='suggestion-item text-danger'>Error loading vendors</div>");
                }
            });
        }, doneTypingInterval);
    });

    // Handle material selection
    $(document).on("click", "#material_suggestions .suggestion-item", function(){
        const material = $(this).data('material');
        selectMaterial(material);
        $("#material_suggestions").empty();
    });

    // Handle vendor selection
    $(document).on("click", "#vendor_suggestions .suggestion-item", function(){
        const vendor = $(this).data('vendor');
        selectVendor(vendor);
        $("#vendor_suggestions").empty();
    });

    // Close suggestions when clicking outside
    $(document).click(function(e){
        if (!$(e.target).closest("#material_search, #material_suggestions").length) {
            $("#material_suggestions").empty();
        }
        if (!$(e.target).closest("#vendor_search, #vendor_suggestions").length) {
            $("#vendor_suggestions").empty();
        }
    });

    // Clear form button
    $("#clear-form").on("click", function() {
        clearForm();
    });
});

function selectMaterial(material) {
    console.log("Selected Material:", material);
    
    // ✅ Fill material fields - NO HIDDEN FIELDS
    $("#material_search").val(material.material_name); // This will be submitted
    $("#material_code").val(material.material_code);
    $("#category").val(material.category || "");
    $("#uom").val(material.uom || "");
    $("#model").val(material.model_name || "");
    $("#brand").val(material.brand_name || "");
    $("#hsn_code").val(material.hsn_code || "");
    
    
    console.log("Material fields auto-filled!");
}

function selectVendor(vendor) {
    console.log("Selected Vendor:", vendor);
    
    // ✅ Fill vendor fields - NO HIDDEN FIELDS
    $("#vendor_search").val(vendor.vendor_name); // This will be submitted
    $("#vendor_code").val(vendor.vendor_code);
    
    console.log("Vendor fields auto-filled!");
}

function clearMaterialFields() {
    $("#material_search").val("");
    $("#material_code").val("");
    $("#category").val("");
    $("#uom").val("");
    $("#model").val("");
    $("#brand").val("");
    $("#hsn_code").val("");
}

function clearVendorFields() {
    $("#vendor_search").val("");
    $("#vendor_code").val("");
}

function clearForm() {
    $("#material_search").val("");
    $("#vendor_search").val("");
    clearMaterialFields();
    clearVendorFields();
    $("#invoice_number").val("");
    $("#quantity").val("");
    
    // Reset to today's date
    const today = new Date().toISOString().split('T')[0];
    $("#grn_date").val(today);
    $("#invoice_date").val(today);
    
    // Re-initialize auto fields
    initializeAutoGeneratedFields();
    
    console.log("Form cleared!");
}

function initializeAutoGeneratedFields() {
    // Auto-generate GRN Number
    const grnNumber = $("#grn_number");
    if (grnNumber.length && !grnNumber.val()) {
        grnNumber.val("GRN" + new Date().getTime());
    }
    
    // Auto-generate Batch Number
    const batchNumber = $("#batch");
    if (batchNumber.length && !batchNumber.val()) {
        batchNumber.val("BATCH" + new Date().getTime());
    }
    
    // Set today's date as default
    const today = new Date().toISOString().split('T')[0];
    
    const grnDate = $("#grn_date");
    if (grnDate.length && !grnDate.val()) {
        grnDate.val(today);
    }
    
    const invoiceDate = $("#invoice_date");
    if (invoiceDate.length && !invoiceDate.val()) {
        invoiceDate.val(today);
    }
}

// Form validation function
function validateForm() {
    console.log("=== FORM VALIDATION CHECK ===");
    
    let isValid = true;
    const errors = [];
    
    // Check material selection - now using material_search value
    const materialSearch = $('#material_search').val();
    console.log("Material Search Value:", materialSearch);
    if (!materialSearch) {
        errors.push('Please select a material from autocomplete');
        $('#material_search').addClass('is-invalid');
        isValid = false;
    } else {
        $('#material_search').removeClass('is-invalid');
    }
    
    // Check vendor selection - now using vendor_search value
    const vendorSearch = $('#vendor_search').val();
    console.log("Vendor Search Value:", vendorSearch);
    if (!vendorSearch) {
        errors.push('Please select a vendor from autocomplete');
        $('#vendor_search').addClass('is-invalid');
        isValid = false;
    } else {
        $('#vendor_search').removeClass('is-invalid');
    }
    
    // Check invoice number
    const invoiceNumber = $('#invoice_number').val();
    console.log("Invoice Number:", invoiceNumber);
    if (!invoiceNumber) {
        errors.push('Invoice number is required');
        $('#invoice_number').addClass('is-invalid');
        isValid = false;
    } else {
        $('#invoice_number').removeClass('is-invalid');
    }
    
    // Check quantity
    const quantity = $('#quantity').val();
    console.log("Quantity:", quantity);
    if (!quantity || quantity <= 0) {
        errors.push('Valid quantity is required');
        $('#quantity').addClass('is-invalid');
        isValid = false;
    } else {
        $('#quantity').removeClass('is-invalid');
    }
    
    console.log("Validation errors:", errors);
    console.log("Form valid:", isValid);
    console.log("=== END VALIDATION ===");
    
    if (errors.length > 0) {
        alert('Please fix the following errors:\n\n' + errors.join('\n'));
    }
    
    return isValid;
}

// Debug form submission
$(document).ready(function() {
    $('#materialInwardForm').on('submit', function(e) {
        console.log('=== FORM SUBMISSION TRIGGERED ===');
        
        // Log all form data for debugging
        const formData = $(this).serializeArray();
        console.log('Form data:', formData);
        
        // Additional debug: Check each field value
        console.log('Field values:');
        console.log('- material_search:', $('#material_search').val());
        console.log('- material_code:', $('#material_code').val());
        console.log('- vendor_search:', $('#vendor_search').val());
        console.log('- vendor_code:', $('#vendor_code').val());
        console.log('- category:', $('#category').val());
        console.log('- uom:', $('#uom').val());
        console.log('- hsn_code:', $('#hsn_code').val());
        console.log('- invoice_number:', $('#invoice_number').val());
        console.log('- quantity:', $('#quantity').val());
        
        if (!validateForm()) {
            console.log('Form validation failed - preventing submission');
            e.preventDefault();
            return false;
        }
        
        console.log('Form validation passed - submitting to server');
        return true;
    });
});