$(document).ready(function(){
     // üîç STRICT PAGE DETECTION - Only run on material inward pages
    const currentPath = window.location.pathname;
    const isMaterialInwardPage = currentPath.includes('/addmaterialinward/') || 
                                currentPath.includes('/materialinward/') ||
                                currentPath.endsWith('/addmaterialinward') ||
                                currentPath.endsWith('/materialinward');
    
    if (!isMaterialInwardPage) {
        console.log('‚è≠Ô∏è Not on material inward page, skipping material inward autocomplete');
        return;
    }
    
    console.log('üîß Initializing Material Inward Autocomplete on:', currentPath);
    let typingTimer;
    const doneTypingInterval = 300;

    // Initialize auto-generated fields
    initializeAutoGeneratedFields();

    // Material Search Autocomplete
    $("#material_search").on("input", function(){
        clearTimeout(typingTimer);
        let query = $(this).val();

        if (query.length === 0) {
            $("#material_suggestions").empty();
            clearMaterialFields();
            return;
        }

        typingTimer = setTimeout(function(){
            $.ajax({
                url: "/ajserp/api/material-autocomplete/",
                data: {q: query},
                dataType: "json",
                success: function(data){
                    console.log("üì° Material API Response for query '" + query + "':", data);
                    let items = "";
                    
                    if (data && data.length > 0) {
                        data.forEach(function(material){
                            items += `
                                <div class="suggestion-item" 
                                     data-material='${JSON.stringify(material)}'>
                                    <strong>${material.material_name}</strong>
                                    <small>${material.material_code}</small>
                                </div>`;
                        });
                        $("#material_suggestions").html(items);
                    } else {
                        $("#material_suggestions").html("<div class='suggestion-item text-muted'>No materials found</div>");
                    }
                },
                error: function(err) {
                    console.error("‚ùå Material API Error:", err);
                    $("#material_suggestions").html("<div class='suggestion-item text-danger'>Error loading materials</div>");
                }
            });
        }, doneTypingInterval);
    });

    // Vendor Search Autocomplete  
    $("#vendor_search").on("input", function(){
        clearTimeout(typingTimer);
        let query = $(this).val();

        if (query.length === 0) {
            $("#vendor_suggestions").empty();
            clearVendorFields();
            return;
        }

        typingTimer = setTimeout(function(){
            $.ajax({
                url: "/ajserp/api/vendor-autocomplete/",
                data: {q: query},
                dataType: "json",
                success: function(data){
                    console.log("üì° Vendor API Response for query '" + query + "':", data);
                    let items = "";
                    
                    if (data && data.length > 0) {
                        data.forEach(function(vendor){
                            items += `
                                <div class="suggestion-item" 
                                     data-vendor='${JSON.stringify(vendor)}'>
                                    <strong>${vendor.vendor_name}</strong>
                                    <small>${vendor.vendor_code}</small>
                                </div>`;
                        });
                        $("#vendor_suggestions").html(items);
                    } else {
                        $("#vendor_suggestions").html("<div class='suggestion-item text-muted'>No vendors found</div>");
                    }
                },
                error: function(err) {
                    console.error("‚ùå Vendor API Error:", err);
                    $("#vendor_suggestions").html("<div class='suggestion-item text-danger'>Error loading vendors</div>");
                }
            });
        }, doneTypingInterval);
    });

    // Handle material selection
    $(document).on("click", "#material_suggestions .suggestion-item", function(){
        const material = $(this).data('material');
        selectMaterial(material);
        $("#material_suggestions").empty();
    });

    // Handle vendor selection
    $(document).on("click", "#vendor_suggestions .suggestion-item", function(){
        const vendor = $(this).data('vendor');
        selectVendor(vendor);
        $("#vendor_suggestions").empty();
    });

    // Close suggestions when clicking outside
    $(document).click(function(e){
        if (!$(e.target).closest("#material_search, #material_suggestions").length) {
            $("#material_suggestions").empty();
        }
        if (!$(e.target).closest("#vendor_search, #vendor_suggestions").length) {
            $("#vendor_suggestions").empty();
        }
    });

    // Clear form button
    $("#clear-form").on("click", function() {
        clearForm();
    });

    // Form validation on submit
    $('#materialInwardForm').on('submit', function(e) {
        console.log('üìù Form submission triggered for material inward');
        
        // Log all form data for debugging
        const formData = $(this).serializeArray();
        console.log('üìã Form data:', formData);
        
        // Additional debug: Check each field value
        console.log('üîç Field values:');
        console.log('- material_search:', $('#material_search').val());
        console.log('- material_code:', $('#material_code').val());
        console.log('- vendor_search:', $('#vendor_search').val());
        console.log('- vendor_code:', $('#vendor_code').val());
        console.log('- category:', $('#category').val());
        console.log('- uom:', $('#uom').val());
        console.log('- hsn_code:', $('#hsn_code').val());
        console.log('- invoice_number:', $('#invoice_number').val());
        console.log('- quantity:', $('#quantity').val());
        
        if (!validateForm()) {
            console.log('‚ùå Form validation failed - preventing submission');
            e.preventDefault();
            return false;
        }
        
        console.log('‚úÖ Form validation passed - submitting to server');
        return true;
    });

    function selectMaterial(material) {
        console.log("üì¶ Selected Material:", material);
        
        // ‚úÖ Fill material fields - NO HIDDEN FIELDS
        $("#material_search").val(material.material_name); // This will be submitted
        $("#material_code").val(material.material_code);
        $("#category").val(material.category || "");
        $("#uom").val(material.uom || "");
        $("#model").val(material.model_name || "");
        $("#brand").val(material.brand_name || "");
        $("#hsn_code").val(material.hsn_code || "");
        
        console.log("‚úÖ Material fields auto-filled!");
    }

    function selectVendor(vendor) {
        console.log("üè≠ Selected Vendor:", vendor);
        
        // ‚úÖ Fill vendor fields - NO HIDDEN FIELDS
        $("#vendor_search").val(vendor.vendor_name); // This will be submitted
        $("#vendor_code").val(vendor.vendor_code);
        
        console.log("‚úÖ Vendor fields auto-filled!");
    }

    function clearMaterialFields() {
        $("#material_search").val("");
        $("#material_code").val("");
        $("#category").val("");
        $("#uom").val("");
        $("#model").val("");
        $("#brand").val("");
        $("#hsn_code").val("");
    }

    function clearVendorFields() {
        $("#vendor_search").val("");
        $("#vendor_code").val("");
    }

    function clearForm() {
        $("#material_search").val("");
        $("#vendor_search").val("");
        clearMaterialFields();
        clearVendorFields();
        $("#invoice_number").val("");
        $("#quantity").val("");
        
        // Reset to today's date
        const today = new Date().toISOString().split('T')[0];
        $("#grn_date").val(today);
        $("#invoice_date").val(today);
        
        // Re-initialize auto fields
        initializeAutoGeneratedFields();
        
        console.log("üßπ Form cleared!");
    }

    function initializeAutoGeneratedFields() {
        // Auto-generate GRN Number
        const grnNumber = $("#grn_number");
        if (grnNumber.length && !grnNumber.val()) {
            grnNumber.val("GRN" + new Date().getTime());
        }
        
        // Auto-generate Batch Number
        const batchNumber = $("#batch");
        if (batchNumber.length && !batchNumber.val()) {
            batchNumber.val("BATCH" + new Date().getTime());
        }
        
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        
        const grnDate = $("#grn_date");
        if (grnDate.length && !grnDate.val()) {
            grnDate.val(today);
        }
        
        const invoiceDate = $("#invoice_date");
        if (invoiceDate.length && !invoiceDate.val()) {
            invoiceDate.val(today);
        }
    }

    // Form validation function
    function validateForm() {
        console.log("üîç Material Inward Form Validation Check");
        
        let isValid = true;
        const errors = [];
        
        // Check material selection - now using material_search value
        const materialSearch = $('#material_search').val();
        console.log("üì¶ Material Search Value:", materialSearch);
        if (!materialSearch) {
            errors.push('‚ùå Please select a material from autocomplete');
            $('#material_search').addClass('is-invalid');
            isValid = false;
        } else {
            $('#material_search').removeClass('is-invalid');
        }
        
        // Check vendor selection - now using vendor_search value
        const vendorSearch = $('#vendor_search').val();
        console.log("üè≠ Vendor Search Value:", vendorSearch);
        if (!vendorSearch) {
            errors.push('‚ùå Please select a vendor from autocomplete');
            $('#vendor_search').addClass('is-invalid');
            isValid = false;
        } else {
            $('#vendor_search').removeClass('is-invalid');
        }
        
        // Check invoice number
        const invoiceNumber = $('#invoice_number').val();
        console.log("üìÑ Invoice Number:", invoiceNumber);
        if (!invoiceNumber) {
            errors.push('‚ùå Invoice number is required');
            $('#invoice_number').addClass('is-invalid');
            isValid = false;
        } else {
            $('#invoice_number').removeClass('is-invalid');
        }
        
        // Check quantity
        const quantity = $('#quantity').val();
        console.log("üî¢ Quantity:", quantity);
        if (!quantity || quantity <= 0) {
            errors.push('‚ùå Valid quantity is required');
            $('#quantity').addClass('is-invalid');
            isValid = false;
        } else {
            $('#quantity').removeClass('is-invalid');
        }
        
        // Check GRN date
        const grnDate = $('#grn_date').val();
        console.log("üìÖ GRN Date:", grnDate);
        if (!grnDate) {
            errors.push('‚ùå GRN date is required');
            $('#grn_date').addClass('is-invalid');
            isValid = false;
        } else {
            $('#grn_date').removeClass('is-invalid');
        }
        
        // Check invoice date
        const invoiceDate = $('#invoice_date').val();
        console.log("üìÖ Invoice Date:", invoiceDate);
        if (!invoiceDate) {
            errors.push('‚ùå Invoice date is required');
            $('#invoice_date').addClass('is-invalid');
            isValid = false;
        } else {
            $('#invoice_date').removeClass('is-invalid');
        }
        
        console.log("üìä Validation errors:", errors);
        console.log("‚úÖ Form valid:", isValid);
        console.log("üîö End validation check");
        
        if (errors.length > 0) {
            alert('‚ö†Ô∏è Please fix the following errors:\n\n' + errors.join('\n'));
        }
        
        return isValid;
    }
});